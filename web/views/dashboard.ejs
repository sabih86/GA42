<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LLMReport Dashboard</title>
  <script src="/static/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #3B82F6;
      --primary-dark: #2563EB;
      --secondary: #64748B;
      --accent: #10B981;
      --success: #059669;
      --warning: #D97706;
      --error: #DC2626;
      --gray-50: #F8FAFC;
      --gray-100: #F1F5F9;
      --gray-200: #E2E8F0;
      --gray-300: #CBD5E1;
      --gray-400: #94A3B8;
      --gray-500: #64748B;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1E293B;
      --gray-900: #0F172A;
      --white: #FFFFFF;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --radius: 8px;
      --radius-lg: 12px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--gray-50);
      color: var(--gray-900);
      line-height: 1.6;
    }

    /* Header */
    .header {
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      padding: 1rem 1.5rem;
      position: sticky;
      top: 0;
      z-index: 40;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 1400px;
      margin: 0 auto;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .header-title h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--gray-900);
    }

    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      padding: 0.5rem;
      cursor: pointer;
      color: var(--gray-600);
      font-size: 1.25rem;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .control-group i {
      color: var(--gray-500);
      font-size: 0.875rem;
    }

    .control-group select {
      background: var(--white);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      color: var(--gray-700);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .control-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
    }

    /* Layout */
    .dashboard-layout {
      display: flex;
      min-height: calc(100vh - 73px);
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: var(--white);
      border-right: 1px solid var(--gray-200);
      position: fixed;
      left: -280px;
      top: 73px;
      height: calc(100vh - 73px);
      overflow-y: auto;
      transition: left 0.3s ease;
      z-index: 30;
    }

    .sidebar.open {
      left: 0;
    }

    .sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 20;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .sidebar-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .sidebar-section {
      padding: 1.5rem;
      border-bottom: 1px solid var(--gray-200);
    }

    .sidebar-section:last-child {
      border-bottom: none;
    }

    .sidebar-section h3 {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--gray-500);
      margin-bottom: 1rem;
    }

    .summary-grid {
      display: grid;
      gap: 0.75rem;
      font-size: 0.875rem;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .summary-label {
      color: var(--gray-600);
      font-weight: 500;
    }

    .summary-value {
      font-weight: 600;
      color: var(--gray-900);
      text-align: right;
      max-width: 60%;
      word-break: break-word;
    }

    .summary-value.highlight {
      color: var(--primary);
    }

    .nav-menu {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: var(--radius);
      color: var(--gray-600);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .nav-item:hover {
      background: var(--gray-50);
      color: var(--gray-900);
    }

    .nav-item.active {
      background: var(--primary);
      color: var(--white);
    }

    .nav-item i {
      width: 1rem;
      text-align: center;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 2rem;
      margin-left: 0;
      transition: margin-left 0.3s ease;
    }

    /* KPI Cards */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .kpi-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-200);
      transition: all 0.2s ease;
    }

    .kpi-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .kpi-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .kpi-info h3 {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gray-600);
      margin-bottom: 0.5rem;
    }

    .kpi-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--gray-900);
    }

    .kpi-icon {
      width: 3rem;
      height: 3rem;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: var(--white);
    }

    .kpi-icon.mentions { background: var(--primary); }
    .kpi-icon.rank { background: var(--accent); }
    .kpi-icon.sov { background: #8B5CF6; }
    .kpi-icon.citations { background: var(--warning); }

    /* Tab Content */
    .content-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-200);
      overflow: hidden;
    }

    .tab-header {
      border-bottom: 1px solid var(--gray-200);
      overflow-x: auto;
    }

    .tab-nav {
      display: flex;
      min-width: max-content;
    }

    .tab-button {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem 1.5rem;
      border: none;
      background: none;
      color: var(--gray-500);
      font-weight: 500;
      font-size: 0.875rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .tab-button:hover {
      color: var(--gray-700);
      background: var(--gray-50);
    }

    .tab-button.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      background: var(--white);
    }

    .tab-button i {
      font-size: 0.875rem;
    }

    .tab-content {
      display: none;
      padding: 2rem;
    }

    .tab-content.active {
      display: block;
    }

    .tab-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 1.5rem;
    }

    /* Keywords Section */
    .keyword-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .keyword-item {
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .keyword-item summary {
      padding: 1rem 1.5rem;
      background: var(--gray-50);
      cursor: pointer;
      font-weight: 600;
      color: var(--gray-900);
      transition: background 0.2s ease;
    }

    .keyword-item summary:hover {
      background: var(--gray-100);
    }

    .keyword-questions {
      padding: 1rem 1.5rem;
      background: var(--white);
    }

    .question-item {
      padding: 0.5rem 0;
      padding-left: 1rem;
      color: var(--gray-600);
      font-size: 0.875rem;
      border-left: 2px solid var(--gray-200);
      margin-left: 0.5rem;
    }

    /* Charts */
    .chart-container {
      margin-bottom: 2rem;
      background: var(--gray-50);
      border-radius: var(--radius);
      padding: 1rem;
    }

    .chart-placeholder {
      background: var(--gray-100);
      border: 2px dashed var(--gray-300);
      border-radius: var(--radius);
      height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: var(--gray-500);
    }

    .chart-placeholder i {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: var(--gray-400);
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      border-radius: var(--radius);
      border: 1px solid var(--gray-200);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
      min-width: 500px;
    }

    th {
      background: var(--gray-50);
      padding: 0.75rem 1rem;
      text-align: left;
      font-weight: 600;
      color: var(--gray-900);
      border-bottom: 1px solid var(--gray-200);
    }

    td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--gray-200);
      color: var(--gray-700);
    }

    tbody tr:hover {
      background: var(--gray-50);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .brand-highlight {
      font-weight: 600;
      color: var(--primary);
    }

    /* Opportunities */
    .opportunities-section {
      margin-bottom: 3rem;
    }

    .opportunities-section h3 {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 1rem;
    }

    .insight-banner {
      background: linear-gradient(135deg, #FEF3C7, #FDE68A);
      border: 1px solid #F59E0B;
      border-radius: var(--radius);
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    .insight-banner.mention {
      background: linear-gradient(135deg, #DBEAFE, #BFDBFE);
      border-color: var(--primary);
    }

    .insight-text {
      font-size: 0.875rem;
      color: var(--gray-800);
    }

    .insight-text strong {
      font-weight: 700;
    }

    /* Opportunities 2 Controls */
    .opp2-controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: var(--gray-50);
      border-radius: var(--radius);
    }

    .opp2-controls label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-700);
    }

    .opp2-controls select {
      background: var(--white);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      padding: 0.5rem;
      font-size: 0.875rem;
    }

    .load-btn {
      background: var(--primary);
      color: var(--white);
      border: none;
      border-radius: var(--radius);
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .load-btn:hover {
      background: var(--primary-dark);
    }
    .tooltip {
  position: relative;
  cursor: pointer;
  color: var(--gray-900);
  display: inline-flex;
  align-items: center;
}

/* FIX 1: make tooltip visible even inside scrollable/hidden containers */
.tooltip-content {
  visibility: hidden;
  opacity: 0;
  position: fixed; /* instead of absolute */
  top: auto;
  left: auto;
  background: var(--white);
  color: var(--gray-900);
  padding: 0.75rem 1rem;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  transition: opacity 0.2s ease, visibility 0.2s ease;
  min-width: 220px;
  max-width: 300px;
  z-index: 9999; /* FIX 2: ensure it floats over sidebar */
  text-align: left;
  pointer-events: none; /* prevents flicker */
}

/* Tooltip arrow */
.tooltip-content::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 20px;
  border-width: 6px;
  border-style: solid;
  border-color: var(--white) transparent transparent transparent;
}

.tooltip-item {
  margin: 0.25rem 0;
  font-size: 0.875rem;
  white-space: nowrap;
}

.tooltip-item a {
  color: var(--primary);
  text-decoration: none;
}

.tooltip-item a:hover {
  text-decoration: underline;
}

/* Show tooltip on hover */
.tooltip:hover .tooltip-content {
  visibility: visible;
  opacity: 1;
}

/* FIX 3: Move tooltip dynamically near mouse */
.tooltip:hover .tooltip-content {
  position: fixed;
  top: calc(var(--tooltip-mouse-y, 0px) + 15px);
  left: calc(var(--tooltip-mouse-x, 0px) + 15px);
}


    .opp2-meta {
      margin-left: 0.75rem;
      color: var(--gray-600);
      font-size: 0.875rem;
    }

    /* Links */
    a {
      color: var(--primary);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .mobile-menu-btn {
        display: block;
      }

      .sidebar {
        position: fixed;
        left: -280px;
        top: 73px;
        height: calc(100vh - 73px);
        z-index: 30;
      }

      .main-content {
        margin-left: 0;
      }

      .header-controls {
        gap: 0.5rem;
      }

      .control-group {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
      }

      .control-group select {
        font-size: 0.75rem;
        padding: 0.375rem 0.5rem;
      }
    }

    @media (max-width: 768px) {
      .header {
        padding: 1rem;
      }

      .header-title h1 {
        font-size: 1.25rem;
      }

      .main-content {
        padding: 1rem;
      }

      .kpi-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }

      .kpi-card {
        padding: 1rem;
      }

      .kpi-value {
        font-size: 1.5rem;
      }

      .kpi-icon {
        width: 2.5rem;
        height: 2.5rem;
        font-size: 1.25rem;
      }

      .tab-content {
        padding: 1rem;
      }

      .tab-button {
        padding: 0.75rem 1rem;
        font-size: 0.75rem;
      }

      .tab-button .tab-text {
        display: none;
      }

      .chart-placeholder {
        height: 250px;
      }

      .chart-placeholder i {
        font-size: 2rem;
      }

      table {
        font-size: 0.75rem;
        min-width: 400px;
      }

      th, td {
        padding: 0.5rem;
      }

      .opp2-controls {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
      }
    }

    @media (max-width: 480px) {
      .kpi-grid {
        grid-template-columns: 1fr;
      }

      .summary-grid {
        gap: 0.5rem;
      }

      .summary-item {
        flex-direction: column;
        gap: 0.25rem;
      }

      .summary-value {
        max-width: 100%;
        text-align: left;
      }
    }

    @media (min-width: 1024px) {
      .sidebar {
        position: static;
        left: 0;
        width: 280px;
      }

      .main-content {
        margin-left: 0;
      }

      .sidebar-overlay {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="header-title">
        <button class="mobile-menu-btn" id="mobileMenuBtn">
          <i class="fas fa-bars"></i>
        </button>
        <h1>LLMReport Dashboard</h1>
      </div>
      <div class="header-controls">
        <div class="control-group">
          <i class="fas fa-cog"></i>
          <select id="providerSelect">
            <% providers.forEach(p => { %>
              <option value="<%= p %>" <%= p===selected.provider?'selected':'' %>>
                <%= p.charAt(0).toUpperCase()+p.slice(1) %>
              </option>
            <% }) %>
          </select>
        </div>
        <div class="control-group">
          <i class="fas fa-calendar"></i>
          <select id="dateSelect">
            <% dates.forEach(d => { %>
              <option value="<%= d %>" <%= d===selected.date?'selected':'' %>>
                <%= new Date(d).toLocaleString('en-US') %>
              </option>
            <% }) %>
          </select>
        </div>
      </div>
    </div>
  </header>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-section">
        <h3>Summary</h3>
        <div class="summary-grid">
          <div class="summary-item">
            <span class="summary-label">Domain:</span>
            <span class="summary-value highlight"><%= summary.domain %></span>
          </div>
          <!-- <div class="summary-item">
            <span class="summary-label">Competitors:</span>
            <span class="summary-value"><%= summary.competitors.length %></span>
          </div> -->
<div class="summary-item">
  <span class="summary-label">Competitors:</span>
  <span class="summary-value tooltip">
    <i class="fas fa-users" style="color: var(--primary); margin-right: 6px;"></i>
    <%= summary.competitors.length %>

    <div class="tooltip-content">
      <% if (summary.competitors && summary.competitors.length) { %>
        <% for (let i = 0; i < summary.competitors.length; i++) { %>
          <div class="tooltip-item">
            <% if (summary.competitorUrls && summary.competitorUrls[i]) { %>
              <a href="<%= summary.competitorUrls[i] %>" target="_blank">
                <i class="fas fa-link" style="margin-right: 6px;"></i>
                <%= summary.competitors[i] %>
              </a>
            <% } else { %>
              <i class="fas fa-building" style="margin-right: 6px; color: var(--gray-600);"></i>
              <%= summary.competitors[i] %>
            <% } %>
          </div>
        <% } %>
      <% } else { %>
        <div class="tooltip-item">No competitors listed</div>
      <% } %>
    </div>
  </span>
</div>



          <div class="summary-item">
            <span class="summary-label">Location:</span>
            <span class="summary-value"><%= location %></span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Platform:</span>
            <span class="summary-value highlight"><%= summary.platform %></span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Keywords:</span>
            <span class="summary-value"><%= summary.totalKeywords %></span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Questions:</span>
            <span class="summary-value"><%= summary.totalQuestions %></span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Total MSV:</span>
            <span class="summary-value"><%= summary.totalMSV.toLocaleString() %></span>
          </div>
        </div>
      </div>

      <div class="sidebar-section">
        <h3>Navigation</h3>
        <div class="nav-menu">
          <button class="nav-item active" data-tab="keywords">
            <i class="fas fa-file-text"></i>
            <span>Keywords & Prompts</span>
          </button>
          <button class="nav-item" data-tab="mentions">
            <i class="fas fa-chart-bar"></i>
            <span>Brand Mentions</span>
          </button>
          <button class="nav-item" data-tab="rank">
            <i class="fas fa-trophy"></i>
            <span>Average Rank</span>
          </button>
          <button class="nav-item" data-tab="sov">
            <i class="fas fa-chart-line"></i>
            <span>Average SOV</span>
          </button>
          <button class="nav-item" data-tab="citations">
            <i class="fas fa-quote-right"></i>
            <span>Citations</span>
          </button>
          <button class="nav-item" data-tab="sentiment">
            <i class="fas fa-heart"></i>
            <span>Sentiment</span>
          </button>
          <button class="nav-item" data-tab="opportunities">
            <i class="fas fa-bullseye"></i>
            <span>Opportunities</span>
          </button>
          <button class="nav-item" data-tab="opportunities-optimizer">
            <i class="fas fa-rocket"></i>
            <span>Optimizer</span>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- KPI Cards -->
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-content">
            <div class="kpi-info">
              <h3>Mentions</h3>
              <div class="kpi-value" id="kpiMentions">–</div>
            </div>
            <div class="kpi-icon mentions">
              <i class="fas fa-bullhorn"></i>
            </div>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-content">
            <div class="kpi-info">
              <h3>Avg. Rank</h3>
              <div class="kpi-value" id="kpiRank">–</div>
            </div>
            <div class="kpi-icon rank">
              <i class="fas fa-chart-bar"></i>
            </div>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-content">
            <div class="kpi-info">
              <h3>Avg. SOV</h3>
              <div class="kpi-value" id="kpiSov">–</div>
            </div>
            <div class="kpi-icon sov">
              <i class="fas fa-chart-line"></i>
            </div>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-content">
            <div class="kpi-info">
              <h3>Citations</h3>
              <div class="kpi-value" id="kpiCites">–</div>
            </div>
            <div class="kpi-icon citations">
              <i class="fas fa-quote-right"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab Content -->
      <div class="content-card">
        <div class="tab-header">
          <div class="tab-nav">
            <button class="tab-button active" data-tab="keywords">
              <i class="fas fa-file-text"></i>
              <span class="tab-text">Keywords & Prompts</span>
            </button>
            <button class="tab-button" data-tab="mentions">
              <i class="fas fa-chart-bar"></i>
              <span class="tab-text">Brand Mentions</span>
            </button>
            <button class="tab-button" data-tab="rank">
              <i class="fas fa-trophy"></i>
              <span class="tab-text">Average Rank</span>
            </button>
            <button class="tab-button" data-tab="sov">
              <i class="fas fa-chart-line"></i>
              <span class="tab-text">Average SOV</span>
            </button>
            <button class="tab-button" data-tab="citations">
              <i class="fas fa-quote-right"></i>
              <span class="tab-text">Citations</span>
            </button>
            <button class="tab-button" data-tab="sentiment">
              <i class="fas fa-heart"></i>
              <span class="tab-text">Sentiment</span>
            </button>
            <button class="tab-button" data-tab="opportunities">
              <i class="fas fa-bullseye"></i>
              <span class="tab-text">Opportunities</span>
            </button>
            <button class="tab-button" data-tab="opportunities-optimizer">
              <i class="fas fa-rocket"></i>
              <span class="tab-text">Optimizer</span>
            </button>
          </div>
        </div>

        <!-- Keywords & Prompts -->
        <div id="keywords" class="tab-content active">
          <h2 class="tab-title">Keywords & Associated Questions</h2>
          <div class="keyword-list" id="kwList"></div>
        </div>

        <!-- Brand Mentions -->
        <div id="mentions" class="tab-content">
          <h2 class="tab-title">Brand Mentions Analysis</h2>
          <div class="chart-container">
            <canvas id="chartMentions" width="600" height="300"></canvas>
          </div>
          <div class="table-container" id="detailMentions"></div>
        </div>

        <!-- Average Rank -->
        <div id="rank" class="tab-content">
          <h2 class="tab-title">Average Ranking Analysis</h2>
          <div class="chart-container">
            <canvas id="chartRank" width="600" height="300"></canvas>
          </div>
          <div class="table-container" id="detailRank"></div>
        </div>

        <!-- Average SOV -->
        <div id="sov" class="tab-content">
          <h2 class="tab-title">Share of Voice Analysis</h2>
          <div class="chart-container">
            <canvas id="chartSov" width="600" height="300"></canvas>
          </div>
          <div class="table-container" id="detailSov"></div>
        </div>

        <!-- Average Sentiment -->
        <div id="sentiment" class="tab-content">
          <h2 class="tab-title">Average Sentiment Analysis</h2>
          <div class="chart-container">
            <canvas id="chartSentiment" width="600" height="300"></canvas>
          </div>
          <div class="table-container" id="detailSentiment"></div>
        </div>

        <!-- Citations -->
        <div id="citations" class="tab-content">
          <h2 class="tab-title">Citations Analysis</h2>
          <div class="chart-container">
            <canvas id="chartCitations" width="600" height="300"></canvas>
          </div>
          <div class="table-container" id="detailCitations"></div>
        </div>

        <!-- Opportunities -->
        <div id="opportunities" class="tab-content">
          <div class="opportunities-section">
            <h3>Ranking Opportunities</h3>
            <div class="insight-banner">
              <p class="insight-text">
                <strong>Insight:</strong> Questions where competitors rank higher than your brand
              </p>
            </div>
            <div class="table-container">
              <table id="oppRankTable">
                <thead>
                  <tr>
                    <th>Keyword</th>
                    <th>Question</th>
                    <th>Top Competitor</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="opportunities-section">
            <h3>Mention Opportunities</h3>
            <div class="insight-banner mention">
              <p class="insight-text">
                <strong>Insight:</strong> Questions where competitors are mentioned but your brand is not
              </p>
            </div>
            <div class="table-container">
              <table id="oppMentionTable">
                <thead>
                  <tr>
                    <th>Keyword</th>
                    <th>Question</th>
                    <th>Competitors Mentioned</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Opportunities 2 (Optimization vs Net New) -->
        <div id="opportunities-optimizer" class="tab-content">
          <h2 class="tab-title">Content Optimization Opportunities</h2>
          <div class="opp2-controls">
            <label>
              Type:
              <select id="opp2Type">
                <option value="all">All</option>
                <option value="ranking">Ranking</option>
                <option value="mention">Mention</option>
              </select>
            </label>
            <button class="load-btn" id="opp2Load">Load Opportunities</button>
            <span class="opp2-meta" id="opp2Meta"></span>
          </div>

          <div class="table-container">
            <table id="opp2Table">
              <thead>
                <tr>
                  <th>Prompt</th>
                  <th>Opportunity</th>
                  <th>Update Type</th>
                  <th>Suggested Existing URL</th>
                  <th>Example Competitor URL</th>
                  <th>Keyword</th>
                  <th>MSV</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Mobile menu functionality
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    function toggleSidebar() {
      sidebar.classList.toggle('open');
      sidebarOverlay.classList.toggle('active');
    }

    mobileMenuBtn.addEventListener('click', toggleSidebar);
    sidebarOverlay.addEventListener('click', toggleSidebar);

    // Register Chart.js plugin
    Chart.register(ChartDataLabels);

    const BRANDS = <%- JSON.stringify(brands) %>;
    const provider = '<%= selected.provider %>';
    const date = '<%= selected.date %>';
    const brand = '<%= selected.brand %>';
    const MY_BRAND = brand;

    // Tab switching functionality
    function switchTab(tabId) {
      // Update tab buttons
      document.querySelectorAll('.tab-button, .nav-item').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelectorAll(`[data-tab="${tabId}"]`).forEach(btn => {
        btn.classList.add('active');
      });

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabId).classList.add('active');

      // Close mobile sidebar when tab is selected
      if (window.innerWidth < 1024) {
        sidebar.classList.remove('open');
        sidebarOverlay.classList.remove('active');
      }
    }

    // Add event listeners for tab switching
    document.querySelectorAll('.tab-button, .nav-item').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabId = btn.getAttribute('data-tab');
        switchTab(tabId);
      });
    });

    // Provider/date change handlers
    document.getElementById('providerSelect').onchange = e =>
      location.search = `?brand=${encodeURIComponent(brand)}&provider=${encodeURIComponent(e.target.value)}&date=${encodeURIComponent(date)}`;
    document.getElementById('dateSelect').onchange = e =>
      location.search = `?brand=${encodeURIComponent(brand)}&provider=${encodeURIComponent(provider)}&date=${encodeURIComponent(e.target.value)}`;

    // Keywords & Prompts
    fetch(`/api/metrics/${provider}?date=${encodeURIComponent(date)}&brand=${encodeURIComponent(brand)}`)
      .then(r => r.json()).then(rows => {
        const kwByTerm = {};
        rows.forEach(r => {
          if (r.question === 'MSV') return;
          if (!kwByTerm[r.keyword]) kwByTerm[r.keyword] = new Set();
          kwByTerm[r.keyword].add(r.question);
        });
        const el = document.getElementById('kwList');
        Object.entries(kwByTerm).forEach(([kw, qs]) => {
          const d = document.createElement('details');
          d.className = 'keyword-item';
          d.innerHTML = `<summary>${kw}</summary>
            <div class="keyword-questions">
              ${Array.from(qs).map(q => `<div class="question-item">– ${q}</div>`).join('')}
            </div>`;
          el.appendChild(d);
        });
      });

    // Generic function for bar charts
    function drawBar({ endpoint, chartId, detailDiv, label, reverse = false, yMin = null, yMax = null }) {
      fetch(`${endpoint}/${provider}?date=${encodeURIComponent(date)}&brand=${encodeURIComponent(brand)}`)
        .then(r => r.json()).then(data => {
          // Update KPI
          const myVal = data.find(r => r.brand === MY_BRAND)?.value || 0;
          const kpiMap = {
            '/api/total-mentions': 'kpiMentions',
            '/api/average-rank': 'kpiRank',
            '/api/average-sov': 'kpiSov',
            '/api/citations-by-brand': 'kpiCites'
          };
          const kpiId = kpiMap[endpoint];
          if (kpiId) {
            document.getElementById(kpiId).textContent = label === 'Avg. SOV'
              ? myVal.toFixed(1) + '%' : myVal;
          }

          // Create chart
          const ctx = document.getElementById(chartId).getContext('2d');
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: BRANDS,
              datasets: [{
                label,
                data: BRANDS.map(b => {
                  const v = data.find(r => r.brand === b)?.value || 0;
                  return label === 'Avg. SOV' ? parseFloat(v) : v;
                }),
                backgroundColor: BRANDS.map(b => b === MY_BRAND ? '#DC2626' : '#3B82F6'),
                borderRadius: 4,
                borderSkipped: false,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: true },
                datalabels: {
                  anchor: 'end',
                  align: 'top',
                  formatter: v => label === 'Avg. SOV' ? v + '%' : v,
                  color: '#374151',
                  font: { weight: 'bold' }
                }
              },
              scales: {
                y: {
                  beginAtZero: (yMin === null ? true : yMin >= 0),
                  reverse,
                  suggestedMin: (yMin === null ? undefined : yMin),
                  suggestedMax: (yMax === null ? undefined : yMax),
                  grid: { color: '#F3F4F6' },
                  ticks: { color: '#6B7280' }
                },
                x: {
                  grid: { display: false },
                  ticks: { color: '#6B7280' }
                }
              }
            }
          });

          // Create detail table
          const tbl = document.createElement('table');
          tbl.innerHTML = `<thead>
            <tr><th>Brand</th><th>${label}</th></tr>
          </thead>`;
          const tb = document.createElement('tbody');
          data.forEach(r => {
            const tr = document.createElement('tr');
            const brandClass = r.brand === MY_BRAND ? 'brand-highlight' : '';
            tr.innerHTML = `<td class="${brandClass}">${r.brand}</td><td>${
              label === 'Avg. SOV'
                ? parseFloat(r.value).toFixed(1) + '%'
                : r.value.toFixed ? r.value.toFixed(1) : r.value
            }</td>`;
            tb.appendChild(tr);
          });
          tbl.appendChild(tb);
          document.getElementById(detailDiv).innerHTML = '';
          document.getElementById(detailDiv).appendChild(tbl);
        });
    }

    // Draw all charts
    drawBar({ endpoint: '/api/total-mentions', chartId: 'chartMentions', detailDiv: 'detailMentions', label: 'Mentions' });
    drawBar({ endpoint: '/api/average-rank', chartId: 'chartRank', detailDiv: 'detailRank', label: 'Avg. Rank', reverse: true });
    drawBar({ endpoint: '/api/average-sov', chartId: 'chartSov', detailDiv: 'detailSov', label: 'Avg. SOV' });
    drawBar({ endpoint: '/api/average-sentiment', chartId: 'chartSentiment', detailDiv: 'detailSentiment', label: 'Avg. Sentiment', yMin: -100, yMax: 100 });
    drawBar({ endpoint: '/api/citations-by-brand', chartId: 'chartCitations', detailDiv: 'detailCitations', label: 'Citations' });

    // Load opportunities data
    fetch(`/api/questions-lower/${provider}?date=${encodeURIComponent(date)}&brand=${encodeURIComponent(brand)}`)
      .then(r => r.json()).then(arr => {
        const tbody = document.querySelector('#oppRankTable tbody');
        arr.forEach(o => {
          tbody.innerHTML += `<tr>
            <td>${o.keyword}</td>
            <td>${o.question}</td>
            <td>${o.topCompetitor}</td>
          </tr>`;
        });
      });

    fetch(`/api/questions-zero-mentions/${provider}?date=${encodeURIComponent(date)}&brand=${encodeURIComponent(brand)}`)
      .then(r => r.json()).then(arr => {
        const tbody = document.querySelector('#oppMentionTable tbody');
        arr.forEach(o => {
          tbody.innerHTML += `<tr>
            <td>${o.keyword}</td>
            <td>${o.question}</td>
            <td>${o.competitors}</td>
          </tr>`;
        });
      });

    // Opportunities 2 functionality
    (function() {
      const typeEl = document.getElementById('opp2Type');
      const metaEl = document.getElementById('opp2Meta');
      const tbody = document.querySelector('#opp2Table tbody');
      const loadBtn = document.getElementById('opp2Load');

      function escapeHtml(s = '') {
        return s.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
      }

      async function loadOpps2() {
        const type = typeEl.value || 'all';
        metaEl.textContent = 'Loading…';
        tbody.innerHTML = '';

        const url = `/api/opportunities?brand=${encodeURIComponent(brand)}&provider=${encodeURIComponent(provider)}&runDate=latest&type=${encodeURIComponent(type)}`;
        const res = await fetch(url);
        const data = await res.json();

        if (!data.rows) {
          metaEl.textContent = 'No data';
          return;
        }
        metaEl.textContent = data.runDate ? `Run: ${data.runDate}` : '';

        for (const r of data.rows) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(r.Prompt)}</td>
            <td>${escapeHtml(r.OpportunityType)}</td>
            <td>${escapeHtml(r.ContentUpdateType)}</td>
            <td>${r.SuggestedExistingUrl ? `<a href="${r.SuggestedExistingUrl}" target="_blank" rel="noopener">${escapeHtml(r.SuggestedExistingUrl)}</a>` : ''}</td>
            <td>${r.ExampleCompetitorUrl ? `<a href="${r.ExampleCompetitorUrl}" target="_blank" rel="noopener">${escapeHtml(r.ExampleCompetitorUrl)}</a>` : ''}</td>
            <td>${escapeHtml(r.Keyword || '')}</td>
            <td>${r.MSV ?? ''}</td>
          `;
          tbody.appendChild(tr);
        }
      }

      loadBtn.addEventListener('click', loadOpps2);

      // Auto-load when tab is first opened
      const newTabBtn = document.querySelector('[data-tab="opportunities-optimizer"]');
      if (newTabBtn) {
        let loadedOnce = false;
        newTabBtn.addEventListener('click', () => {
          if (!loadedOnce) {
            loadedOnce = true;
            loadOpps2();
          }
        });
      }
    })();
  </script>
  <script>
  // Keep tooltip visible and properly positioned even if inside overflow:hidden container
  document.addEventListener('mousemove', (e) => {
    document.documentElement.style.setProperty('--tooltip-mouse-x', e.clientX + 'px');
    document.documentElement.style.setProperty('--tooltip-mouse-y', e.clientY + 'px');
  });
</script>

</body>
</html>
